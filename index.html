<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>wikix</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="wikix"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="wikix"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="a boring backend developer who has a big dream"><meta property="og:type" content="blog"><meta property="og:title" content="wikix"><meta property="og:url" content="http://wikix.github.io/"><meta property="og:site_name" content="wikix"><meta property="og:description" content="a boring backend developer who has a big dream"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://wikix.github.io/img/og_image.png"><meta property="article:author" content="wikix"><meta property="article:tag" content="linux,docker,kubernetes,network,kernel"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://wikix.github.io"},"headline":"wikix","image":["http://wikix.github.io/img/og_image.png"],"author":{"@type":"Person","name":"wikix"},"description":"a boring backend developer who has a big dream"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.svg" alt="wikix" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="follow me on GitHub" href="https://github.com/wikix"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-03-08T16:17:05.000Z" title="3/9/2021, 12:17:05 AM">2021-03-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-03-08T08:26:57.692Z" title="3/8/2021, 4:26:57 PM">2021-03-08</time></span><span class="level-item"><a class="link-muted" href="/categories/network/">network</a></span><span class="level-item">20 minutes read (About 2988 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/09/TCP-IP-%E7%9F%A5%E8%AF%86%E7%82%B9/">TCP/IP 知识点</a></h1><div class="content"><p>tcp/ip 知识点</p>
<p><img src="/images/tcp-1.png" alt="tcp-1"></p>
<p>linux 简单的命令访问网站并返回http数据包信息示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 建立一个非 浏览器 的 http 连接并读取返回信息</span></span><br><span class="line">exec 8&lt;&gt; /dev/tcp/www.baidu.com/80</span><br><span class="line">echo -e &#x27;GET / HTTP/1.0\n&#x27; 1&gt;&amp; 8</span><br><span class="line">cat &lt;&amp;8</span><br><span class="line"></span><br><span class="line">获取到baidu HTTP协议返回信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> linux 进程打开 socket/inode等文件描述（本质：文件系统）</span></span><br><span class="line">[root@master1 fd]# ps -ef| grep kubelet</span><br><span class="line">root      1538  1513  2 Jun22 ?        1-20:53:43 kube-apiserver --advertise-address=10.33.41.132 --allow-privileged=true --authentication-token-webhook-config-file=/etc/kubernetes/configs/authwebhookconfig.yaml --authorization-mode=Node,RBAC --client-ca-file=/etc/kubernetes/pki/ca.crt --enable-admission-plugins=NodeRestriction --enable-bootstrap-token-auth=true --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key --etcd-servers=https://127.0.0.1:2379 --event-ttl=12h --feature-gates=TaintBasedEvictions=false,TTLAfterFinished=true --insecure-port=0 --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key --requestheader-allowed-names=front-proxy-client --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6443 --service-account-key-file=/etc/kubernetes/pki/sa.pub --service-cluster-ip-range=10.96.0.0/12 --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/pki/apiserver.crt --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 --tls-min-version=VersionTLS12 --tls-private-key-file=/etc/kubernetes/pki/apiserver.key</span><br><span class="line">root      6914     1  3 Jun22 ?        2-05:27:31 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgroup-driver=systemd --dynamic-config-dir=/var/lib/kubelet/dynamic --network-plugin=cni --node-ip=10.33.41.132 --pod-infra-container-image=docker.hikcloud:30001/k8ss/pause:3.1 --root-dir=/var/lib/kubelet</span><br><span class="line">root     31042 16717  0 10:35 pts/1    00:00:00 grep --color=auto kubelet</span><br><span class="line">[root@master1 fd]# cd /proc/6914/fd</span><br><span class="line">[root@master1 fd]# ls -l</span><br><span class="line">total 0</span><br><span class="line">lr-x------ 1 root root 64 Aug 31 10:08 0 -&gt; /dev/null</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 1 -&gt; socket:[123625]</span><br><span class="line">l-wx------ 1 root root 64 Aug 31 10:08 10 -&gt; pipe:[125488]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 11 -&gt; socket:[124397]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 12 -&gt; socket:[124404]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 13 -&gt; socket:[169557354]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 14 -&gt; socket:[125570]</span><br><span class="line">lr-x------ 1 root root 64 Aug 31 10:08 15 -&gt; anon_inode:inotify</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 16 -&gt; socket:[230272123]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 17 -&gt; socket:[125528]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 18 -&gt; socket:[125529]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 19 -&gt; socket:[122620]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 2 -&gt; socket:[123625]</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 20 -&gt; socket:[122621]</span><br><span class="line">lr-x------ 1 root root 64 Aug 31 10:08 21 -&gt; anon_inode:inotify</span><br><span class="line">lrwx------ 1 root root 64 Aug 31 10:08 22 -&gt; anon_inode:[eventpoll]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看相关文件描述符</span></span><br><span class="line">[root@master1 fd]# lsof -p 6914</span><br><span class="line">COMMAND  PID USER   FD      TYPE             DEVICE  SIZE/OFF      NODE NAME</span><br><span class="line">kubelet 6914 root  cwd       DIR              254,0       224        64 /</span><br><span class="line">kubelet 6914 root  rtd       DIR              254,0       224        64 /</span><br><span class="line">kubelet 6914 root  txt       REG              254,0 111568408 403332145 /usr/bin/kubelet</span><br><span class="line">kubelet 6914 root  mem       REG              254,0     61624     36683 /usr/lib64/libnss_files-2.17.so</span><br><span class="line">kubelet 6914 root  mem       REG              254,0   2151672     36665 /usr/lib64/libc-2.17.so</span><br><span class="line">kubelet 6914 root  mem       REG              254,0     19288     36671 /usr/lib64/libdl-2.17.so</span><br><span class="line">kubelet 6914 root  mem       REG              254,0    141968     36691 /usr/lib64/libpthread-2.17.so</span><br><span class="line">kubelet 6914 root  mem       REG              254,0    163400     36658 /usr/lib64/ld-2.17.so</span><br><span class="line">kubelet 6914 root    0r      CHR                1,3       0t0      6352 /dev/null</span><br><span class="line">kubelet 6914 root    1u     unix 0xffff88c912dbd400       0t0    123625 socket</span><br><span class="line">kubelet 6914 root    2u     unix 0xffff88c912dbd400       0t0    123625 socket</span><br><span class="line">kubelet 6914 root    3u     unix 0xffff88ca94f53c00       0t0    124265 @00071</span><br><span class="line">kubelet 6914 root    4u  a_inode               0,10         0      6348 [eventpoll]</span><br><span class="line">kubelet 6914 root    5u     unix 0xffff88c8f5b23800       0t0    122558 socket</span><br><span class="line">kubelet 6914 root    6r  a_inode               0,10         0      6348 inotify</span><br><span class="line">kubelet 6914 root    7u     unix 0xffff88cac1311000       0t0    123654 socket</span><br><span class="line">kubelet 6914 root    8u  a_inode               0,10         0      6348 [eventpoll]</span><br><span class="line">kubelet 6914 root    9r     FIFO                0,9       0t0    125488 pipe</span><br><span class="line">kubelet 6914 root   10w     FIFO                0,9       0t0    125488 pipe</span><br><span class="line">kubelet 6914 root   11u     unix 0xffff88ca94f51800       0t0    124397 /var/run/387454838</span><br><span class="line">kubelet 6914 root   12u     IPv4             124404       0t0       TCP localhost:42420 (LISTEN)</span><br><span class="line">kubelet 6914 root   13u     IPv6          169557354       0t0       TCP master1:10250-&gt;master3:64790 (ESTABLISHED)</span><br><span class="line">kubelet 6914 root   14u     unix 0xffff88cac1310800       0t0    125570 socket</span><br><span class="line">kubelet 6914 root   15r  a_inode               0,10         0      6348 inotify</span><br><span class="line">kubelet 6914 root   16u     unix 0xffff88c91a133000       0t0 230272123 socket</span><br><span class="line">kubelet 6914 root   17u     unix 0xffff88c93dcb8c00       0t0    125528 socket</span><br><span class="line">kubelet 6914 root   18u     unix 0xffff88ca93e43800       0t0    125529 socket</span><br><span class="line">kubelet 6914 root   19u     unix 0xffff88c93dcbb800       0t0    122620 /var/run/387454838</span><br><span class="line">kubelet 6914 root   20u     unix 0xffff88ca93e40c00       0t0    122621 /var/run/387454838</span><br><span class="line">kubelet 6914 root   21r  a_inode               0,10         0      6348 inotify</span><br><span class="line">kubelet 6914 root   22u  a_inode               0,10         0      6348 [eventpoll]</span><br><span class="line">kubelet 6914 root   23r     FIFO                0,9       0t0    125542 pipe</span><br><span class="line">kubelet 6914 root   24w     FIFO                0,9       0t0    125542 pipe</span><br><span class="line">kubelet 6914 root   25r      CHR               1,11       0t0      6358 /dev/kmsg</span><br><span class="line">kubelet 6914 root   26u     IPv6             124463       0t0       TCP *:10250 (LISTEN)</span><br><span class="line">kubelet 6914 root   27u     unix 0xffff88caebebd800       0t0    125589 /var/lib/kubelet/device-plugins/kubelet.sock</span><br><span class="line">kubelet 6914 root   28u     unix 0xffff88cac1313c00       0t0    125549 /var/lib/kubelet/pod-resources/283926109</span><br><span class="line">kubelet 6914 root   29u     IPv4             125551       0t0       TCP localhost:10248 (LISTEN)</span><br><span class="line">kubelet 6914 root   30u     unix 0xffff88ca83a21400       0t0 229931580 socket</span><br><span class="line">kubelet 6914 root   31r  a_inode               0,10         0      6348 inotify</span><br><span class="line">kubelet 6914 root   33r      CHR               1,11       0t0      6358 /dev/kmsg</span><br><span class="line">kubelet 6914 root   34r  a_inode               0,10         0      6348 inotify</span><br><span class="line">kubelet 6914 root   35u  a_inode               0,10         0      6348 [eventpoll]</span><br><span class="line">kubelet 6914 root   36r     FIFO                0,9       0t0    125593 pipe</span><br><span class="line">kubelet 6914 root   37w     FIFO                0,9       0t0    125593 pipe</span><br><span class="line">kubelet 6914 root   38u     unix 0xffff88cac1386000       0t0    124529 socket</span><br><span class="line">kubelet 6914 root   39u     unix 0xffff88caf6d00c00       0t0    123724 socket</span><br><span class="line">kubelet 6914 root   43u     IPv4          168915864       0t0       TCP kubernetes.cluster.local.lb:38676-&gt;kubernetes.cluster.local.lb:16443 (ESTABLISHED)</span><br></pre></td></tr></table></figure>



<ul>
<li>fd  ——&gt; 文件描述符（变量）</li>
</ul>
<hr>
<h4 id="传输控制层"><a href="#传输控制层" class="headerlink" title="传输控制层"></a>传输控制层</h4><p><img src="/images/tcp-2.png" alt="tcp-2"></p>
<p>tcp/udp（传输控制层）</p>
<p>上面网络层为应用层，应用层基于 <code>传输控制层</code> 建立的连接，来进行数据传输</p>
<p>！连接是什么？连接如何建立？</p>
<p><img src="/images/tcp-3.png" alt="tcp-3"></p>
<p>连接，就是双方都有资源，能够为双方的应用提供服务，进行数据传输。</p>
<p>tcp/udp连接，虚拟概念，底层由内核文件系统 + 数据io + 更底层网络协议实现</p>
<hr>
<p>tcp：面向连接可靠的传输协议</p>
<ul>
<li>建立连接：</li>
</ul>
<p>三次握手：client 发出 syn —— server 返回 syn + ack —— client发出 ack ——&gt;</p>
<ul>
<li>数据传输：</li>
</ul>
<p>client &amp; server 申请一定资源，建立连接通信进行数据传输 ——&gt;</p>
<ul>
<li>断开连接：</li>
</ul>
<p>四次分手：双方socket资源释放</p>
<p>client 发出fin—— server 返回 fin + ack—— server发出 fin —— client发出 ack。（到此结束）</p>
<p>！三次握手、四次分手过程中，发出的信号包（例如ack确认），长度都为 0</p>
<p><img src="/images/tcp-4.png" alt="tcp-4"></p>
<p>socket ——&gt; [client ip:client port -&gt; server-ip:server port]  四元组</p>
<p>不同ip服务器同个端口，均可以建立 65535 个连接</p>
<p><img src="/images/tcp-5.png" alt="tcp-5"></p>
<hr>
<p>查看操作系统网络状态 netstat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">netstat -natp</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">[root@master1 ~]# netstat -natp</span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name</span><br><span class="line">tcp        0      0 127.0.0.1:10259         0.0.0.0:*               LISTEN      26858&#x2F;kube-schedule</span><br><span class="line">tcp        0      0 127.0.0.1:42420         0.0.0.0:*               LISTEN      6914&#x2F;kubelet</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      3365&#x2F;sshd</span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      3862&#x2F;master</span><br><span class="line">tcp        0      0 0.0.0.0:16443           0.0.0.0:*               LISTEN      28115&#x2F;haproxy</span><br><span class="line">tcp        0      0 127.0.0.1:9182          0.0.0.0:*               LISTEN      11322&#x2F;.&#x2F;bin&#x2F;k8s-key</span><br><span class="line">tcp        0      0 0.0.0.0:9119            0.0.0.0:*               LISTEN      28115&#x2F;haproxy</span><br><span class="line">tcp        0      0 0.0.0.0:8067            0.0.0.0:*               LISTEN      28115&#x2F;haproxy</span><br><span class="line">tcp        0      0 127.0.0.1:10248         0.0.0.0:*               LISTEN      6914&#x2F;kubelet</span><br><span class="line">tcp        0      0 0.0.0.0:8073            0.0.0.0:*               LISTEN      28115&#x2F;haproxy</span><br><span class="line">tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      2848&#x2F;kube-proxy</span><br><span class="line">tcp        0      0 0.0.0.0:8074            0.0.0.0:*               LISTEN      28115&#x2F;haproxy</span><br><span class="line">tcp        0      0 127.0.0.1:2381          0.0.0.0:*               LISTEN      1576&#x2F;etcd</span><br><span class="line">tcp        0      0 127.0.0.1:10257         0.0.0.0:*               LISTEN      26883&#x2F;kube-controll</span><br><span class="line">tcp        0      0 0.0.0.0:30001           0.0.0.0:*               LISTEN      28115&#x2F;haproxy</span><br><span class="line">tcp        0      0 127.0.0.1:46448         127.0.0.1:9180          TIME_WAIT   -</span><br><span class="line">tcp        0      0 127.0.0.1:46816         127.0.0.1:9180          TIME_WAIT   -</span><br><span class="line">tcp        0      0 127.0.0.1:45914         127.0.0.1:9180          TIME_WAIT   -</span><br><span class="line">tcp        0      0 127.0.0.1:2381          127.0.0.1:41694         TIME_WAIT   -</span><br><span class="line">tcp        0      0 127.0.0.1:46886         127.0.0.1:9180          TIME_WAIT   -</span><br><span class="line">tcp        0      0 127.0.0.1:57580         127.0.0.1:2379          ESTABLISHED 1538&#x2F;kube-apiserver</span><br><span class="line">tcp        0      0 127.0.0.1:57478         127.0.0.1:2379          ESTABLISHED 1538&#x2F;kube-apiserver</span><br><span class="line">tcp        0      0 127.0.0.1:57594         127.0.0.1:2379          ESTABLISHED 1538&#x2F;kube-apiserver</span><br></pre></td></tr></table></figure>



<p>在 tcp/udp 连接的传输过程中，任何一方发出 数据包，另一方都要发出 ack 确认动作</p>
<p><img src="/images/tcp-6.png" alt="tcp-6"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i (设备名) nn(非机密信息掩饰) port (端口) -X(可选，是否查看数据包内具体内容)</span><br></pre></td></tr></table></figure>



<p><img src="/images/tcp-7.png" alt="tcp-7"></p>
<hr>
<p>nc程序，可以与指定 ip + port 建立连接。nc客户端执行 get、post、put请求。四次分手，可以 FIN和ACK包一起发，只需要3次</p>
<p>建立连接过程中，tcp/udp连接建立会带有 <code>?</code> 因为数据包的收发还依赖底层（网络层[数据包收发形式]）</p>
<hr>
<h4 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h4><ul>
<li><p>IP</p>
</li>
<li><p>route</p>
</li>
</ul>
<p>互联网（很多小的网络互相连接起来），主机IP访问（网络号+主机位）</p>
<p>/etc/sysconfig/network-scripts/ifcfg-eth0</p>
<p>IPADDR ip地址</p>
<p>NETMASK 掩码</p>
<p>GATEWAY 网关</p>
<p>DNS 域名解析服务器</p>
<p>IP + NETMASK 与运算，得到——网络号</p>
<p>路由表</p>
<p>查看路由表</p>
<p>GATEWAY 0.0.0.0，即不需要 走 路由器/网关（即无需下一跳），网络直连，直接与同网段 ip 节点互相通信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.33.41.254    0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.33.41.0      0.0.0.0         255.255.255.0   U     0      0        0 eth0</span><br><span class="line">10.244.0.0      0.0.0.0         255.255.255.0   U     0      0        0 cni0</span><br><span class="line">10.244.1.0      10.244.1.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.244.2.0      10.244.2.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.244.5.0      10.244.5.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">10.244.6.0      10.244.6.0      255.255.255.0   UG    0      0        0 flannel.1</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br></pre></td></tr></table></figure>



<p>路由表</p>
<p>作用：</p>
<p>记录当前局域网（局部互联网）所有的连接信息，为 网络路由（网关节点、路由器、流量发出节点） 提供下一跳的 依据</p>
<p>原理：</p>
<p>网络中下一跳点，必有流量入口，另外一个流量出口</p>
<p>举例：</p>
<p>发送给百度数据包。（本机ip 192.168.150.2，百度ip 61.135.169.121），对于发送到外部网络的流量</p>
<p>通过 <code>Genmask</code> 掩码进行与运算匹配</p>
<p>1）255.255.255.0  计算后 得到  目标地址：192.168.150.0 为当前网络段，网络直连。</p>
<p>2）0.0.0.0 计算后 得到 0.0.0.0，即目标地址为 0.0.0.0，走到网关 192.168.150.0，由网关/路由器所在节点决定网络下一跳。</p>
<p>走 <code>Iface</code> 设备 流量出入，走到 网关/路由器所在节点，决定下一跳地址。</p>
<p>此时发送的目标地址为 61.135.169.121，为了保证这个数据包能够发送到 网关节点，需要为数据包的 目的地址、端口 提供 额外地址信息，即网关/路由器 节点的 MAC 地址（即链路层协议在 网络层数据包外  添加 自身数据包 封装）</p>
<p>数据包发到 服务端，根据 目的ip 发送到指定处理的节点，根据 目标端口，查找在服务器上的对应进程，并进行 数据处理，实现 进程与进程间网络通信。</p>
<p><img src="/images/tcp-8.png" alt="tcp-8"></p>
<hr>
<h4 id="链路层"><a href="#链路层" class="headerlink" title="链路层"></a>链路层</h4><p>链路层地址数据库维护</p>
<p>查看该数据库 arp -a</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]# arp -a</span><br><span class="line">? (172.17.0.2) at 02:42:ac:11:00:02 [ether] on docker0</span><br><span class="line">node1 (10.33.41.135) at fa:16:3e:99:4b:46 [ether] on eth0</span><br><span class="line">kubernetes.cluster.local.lb (10.33.41.130) at &lt;incomplete&gt; on eth0</span><br><span class="line">? (10.33.41.250) at 50:98:b8:19:af:1f [ether] on eth0</span><br><span class="line">node2 (10.33.41.136) at fa:16:3e:8f:eb:a6 [ether] on eth0</span><br><span class="line">? (10.33.41.131) at e8:61:1f:21:87:c9 [ether] on eth0</span><br><span class="line">? (10.33.41.251) at 74:ea:cb:2d:cd:68 [ether] on eth0</span><br><span class="line">master1 (10.33.41.126) at fa:16:3e:8f:eb:a6 [ether] on eth0</span><br><span class="line">? (10.33.41.137) at fa:16:3e:1a:2e:f3 [ether] on eth0</span><br></pre></td></tr></table></figure>



<p>找到 目标设备网卡的 MAC 地址。</p>
<p><img src="/images/tcp-9.png" alt="tcp-9"></p>
<p>例如，访问 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a></p>
<p>从 client端发起网络请求，请求数据包—— 百度服务器的IP地址和 （家内/小区内）路由器 的 MAC 地址 </p>
<p>中间路由器——将请求数据包（ 目标ip、端口不变，修改目标MAC地址）</p>
<p>中间服务器到百度服务器——百度服务器ip地址和端口 &amp; 百度服务器MAC地址</p>
<p>类似链表结构（每次原数据不变化，跳转地址变化）</p>
<hr>
<p>ip 路由表 本身可以有记录（系统启动时，读取网卡配置项即可）</p>
<p>路由表信息——也称 静态路由。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">网关代表下一跳！ Next Jump</span><br></pre></td></tr></table></figure>





<p>arp mac相关地址信息无记录，必须通过网络请求后，请求完成后添加、更新记录。</p>
<p>即，第一次发出数据包/网络请求时，arp会请求 目标ip节点 的 MAC 地址。</p>
<p>问题？当arp申请mac地址时，它不知道目标 ip的 mac 地址，如何将包发给正确 mac 地址，然后申请获得目标ip的 mac信息呢？</p>
<p>—— arp会广播给局域网所有节点（广播MAC地址为 全 ff 的MAC 地址），仅目标 ip 的 mac 会响应，以此发现目标ip的mac地址</p>
<p>所以，为什么网络是分层的？</p>
<p>层和层之间有依赖关系。</p>
<p>！！！</p>
<p>因此，第一次建立连接前，即三次握手前，需要 发出 <code>arp 请求</code>，获取目标MAC地址</p>
<p>获取到MAC地址后，才开始 三次握手 等 tcp/ip 层网络连接</p>
<p>示例命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp -d 192.168.150.2 &amp;&amp; curl www.baidu.com</span><br></pre></td></tr></table></figure>





<img src="/images/tcp-10.png" alt="tcp-10" />

<p><img src="/images/tcp-11.png" alt="tcp-11"></p>
<p>网络方面，-n / -nn 为是否展示详细信息</p>
<hr>
<p><img src="/images/tcp-12.png" alt="tcp-12"></p>
<p>回环设备——Loop Device</p>
<p>路由表规划不对，需要网工（人为维护）——SDN的源头</p>
<p><img src="/images/tcp-13.png" alt="tcp-13"></p>
<p><img src="/images/tcp-14.png" alt="tcp-14"></p>
<p>有了网络知识，才能入坑并发时，socket处理，以及并行度相关知识</p>
<p>网络——》并发——》并行度</p>
<hr>
<p>交换机、路由器、网关的关系？</p>
<p>路由器：三层设备，存有路由表，看IP地址</p>
<p>交换机：二层设备，物理层/链路层，看MAC地址，不能作为两个网络区域 连接的使用</p>
<p>家用路由器：交换机+路由器结合，四个插口为交换机口；路由器接两条线，一条接交换机、一条接ISP运营商</p>
<p>NAT：地址转换协议</p>
<hr>
<p>高薪程序员：M+N（内在和外在兼修）</p>
<p>M：个人修行</p>
<p>设计模式</p>
<p>多线程 + 高并发 JUC</p>
<p>网络到分布式：redis、zookeeper、elasticsearch、mq</p>
<p>调优：OSKernel</p>
<p>N：项目经验，即场景</p>
<p>整合《——》技术《——》问题</p>
<p>技术：落地到应用场景</p>
<hr>
<p>一个问题：技术选项——技术特征、原理、源码、！场景！</p>
<hr>
<p>整合一些技术，再解决问题。——<code>结合点</code></p>
<hr>
<p>在实际工作中   辩证    实践验证技术特征、能力。</p>
<p>例如 ssm，需要高并发，引入负载均衡（lvs）</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-03-08T16:06:40.000Z" title="3/9/2021, 12:06:40 AM">2021-03-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-03-08T08:27:13.364Z" title="3/8/2021, 4:27:13 PM">2021-03-08</time></span><span class="level-item"><a class="link-muted" href="/categories/kubernetes-container/">kubernetes, container</a></span><span class="level-item">16 minutes read (About 2338 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/09/flagger-%E8%A7%A3%E6%9E%90/">flagger 解析</a></h1><div class="content"><h1 id="flagger"><a href="#flagger" class="headerlink" title="flagger"></a>flagger</h1><h3 id="应用自动发布组件"><a href="#应用自动发布组件" class="headerlink" title="应用自动发布组件"></a>应用自动发布组件</h3><p>官网地址</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/weaveworks/flagger">https://github.com/weaveworks/flagger</a></p>
<h4 id="官方介绍"><a href="#官方介绍" class="headerlink" title="官方介绍"></a>官方介绍</h4><p><a target="_blank" rel="noopener" href="https://github.com/weaveworks/flagger">Flagger</a> can be configured to automate the release process for Kubernetes workloads with a custom resource named canary.</p>
<h4 id="支持的-custom-resource（即下文中的-provider）"><a href="#支持的-custom-resource（即下文中的-provider）" class="headerlink" title="支持的 custom resource（即下文中的 provider）"></a>支持的 custom resource（即下文中的 provider）</h4><p>- istio</p>
<p>- Linkerd</p>
<p>- App Mesh</p>
<p>- Nginx</p>
<p>- contour</p>
<p>- CNI</p>
<p>- Kubernetes</p>
<h4 id="组件架构图"><a href="#组件架构图" class="headerlink" title="组件架构图"></a>组件架构图</h4><img src="/images/flagger-arch.png" alt="flagger-arch" style="zoom:80%;" />

<h6 id="架构图解释"><a href="#架构图解释" class="headerlink" title="架构图解释"></a>架构图解释</h6><p>- primary service：已发布的在线服务（旧版本）</p>
<p>- canary service： 即将发布的新版本服务（新版本）</p>
<p>- Ingress：发布过程中发布粒度控制的 提供者</p>
<p>- Flagger：通过Flagger Spec 以 提供者提供的规范来调整 primary 与 canary 的 流量/副本运行 策略。调整过程中，根据 prometheus 采集的各项指标来决策是否回滚发布 或者 继续调整 流量/副本运行 比例。！！！此过程中，用户可自定义是否人工干预、审核、通知等动作。</p>
<p>示例 yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flagger.app/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Canary</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># service mesh provider (optional)</span></span><br><span class="line">  <span class="comment"># can be: kubernetes, istio, linkerd, appmesh, nginx, contour, gloo, supergloo</span></span><br><span class="line">  <span class="attr">provider:</span> <span class="string">istio</span></span><br><span class="line">  <span class="comment"># deployment reference</span></span><br><span class="line">  <span class="attr">targetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="comment"># the maximum time in seconds for the canary deployment</span></span><br><span class="line">  <span class="comment"># to make progress before it is rollback (default 600s)</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">60</span></span><br><span class="line">  <span class="comment"># HPA reference (optional)</span></span><br><span class="line">  <span class="attr">autoscalerRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="comment"># service name (defaults to targetRef.name)</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">    <span class="comment"># ClusterIP port number</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9898</span></span><br><span class="line">    <span class="comment"># container port name or number (optional)</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9898</span></span><br><span class="line">    <span class="comment"># port name can be http or grpc (default http)</span></span><br><span class="line">    <span class="attr">portName:</span> <span class="string">http</span></span><br><span class="line">    <span class="comment"># add all the other container ports</span></span><br><span class="line">    <span class="comment"># to the ClusterIP services (default false)</span></span><br><span class="line">    <span class="attr">portDiscovery:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># HTTP match conditions (optional)</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">          <span class="attr">prefix:</span> <span class="string">/</span></span><br><span class="line">    <span class="comment"># HTTP rewrite (optional)</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">/</span></span><br><span class="line">    <span class="comment"># request timeout (optional)</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">  <span class="comment"># promote the canary without analysing it (default false)</span></span><br><span class="line">  <span class="attr">skipAnalysis:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># define the canary analysis timing and KPIs</span></span><br><span class="line">  <span class="attr">analysis:</span></span><br><span class="line">    <span class="comment"># schedule interval (default 60s)</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="comment"># max number of failed metric checks before rollback</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># max traffic percentage routed to canary</span></span><br><span class="line">    <span class="comment"># percentage (0-100)</span></span><br><span class="line">    <span class="attr">maxWeight:</span> <span class="number">50</span></span><br><span class="line">    <span class="comment"># canary increment step</span></span><br><span class="line">    <span class="comment"># percentage (0-100)</span></span><br><span class="line">    <span class="attr">stepWeight:</span> <span class="number">5</span></span><br><span class="line">    <span class="comment"># validation (optional)</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">request-success-rate</span></span><br><span class="line">      <span class="comment"># builtin Prometheus check</span></span><br><span class="line">      <span class="comment"># minimum req success rate (non 5xx responses)</span></span><br><span class="line">      <span class="comment"># percentage (0-100)</span></span><br><span class="line">      <span class="attr">thresholdRange:</span></span><br><span class="line">        <span class="attr">min:</span> <span class="number">99</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">request-duration</span></span><br><span class="line">      <span class="comment"># builtin Prometheus check</span></span><br><span class="line">      <span class="comment"># maximum req duration P99</span></span><br><span class="line">      <span class="comment"># milliseconds</span></span><br><span class="line">      <span class="attr">thresholdRange:</span></span><br><span class="line">        <span class="attr">max:</span> <span class="number">500</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;database connections&quot;</span></span><br><span class="line">      <span class="comment"># custom Prometheus check</span></span><br><span class="line">      <span class="attr">templateRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">db-connections</span></span><br><span class="line">      <span class="attr">thresholdRange:</span></span><br><span class="line">        <span class="attr">min:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">max:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="comment"># testing (optional)用户自定义干预</span></span><br><span class="line">    <span class="attr">webhooks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;conformance test&quot;</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">pre-rollout</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://flagger-helmtester.test/</span></span><br><span class="line">        <span class="attr">timeout:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">&quot;helmv3&quot;</span></span><br><span class="line">          <span class="attr">cmd:</span> <span class="string">&quot;test run podinfo -n test&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;load test&quot;</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">rollout</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://flagger-loadtester.test/</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">cmd:</span> <span class="string">&quot;hey -z 1m -q 10 -c 2 http://podinfo.test:9898/&quot;</span></span><br><span class="line">    <span class="comment"># alerting (optional)</span></span><br><span class="line">    <span class="attr">alerts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;dev team Slack&quot;</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">error</span></span><br><span class="line">        <span class="attr">providerRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dev-slack</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">flagger</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;qa team Discord&quot;</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">warn</span></span><br><span class="line">        <span class="attr">providerRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">qa-discord</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;on-call MS Teams&quot;</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">info</span></span><br><span class="line">        <span class="attr">providerRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">on-call-msteams</span></span><br></pre></td></tr></table></figure>



<p>基本使用</p>
<p>- targetRef: 当前部署的新版本服务(可以是Deployment, 也可以是DaemonSet).</p>
<p>- progressDeadlineSeconds: canary, primary 部署超时时间.如果超过这个时间还没有部署好, 则不会进行 流量/组件副本 调整.</p>
<p>- autoscalerRef: K8s原生的<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HPA</a>(自动伸缩).</p>
<p>- service: k8s service。当provider是Istio时, 和VirtualSercice(具有调整流量比例,路由策略等能力)相对应</p>
<p>- skipAnalysis: 是否跳过metrcis分析. 如果为true, 相当于一次性将primary替换成canary service.</p>
<p>分析</p>
<p>analysis:</p>
<p>- 包含一些调整primary, canary流量策略配置</p>
<p>- metrics: 指标来源. 例如: avg RT, 成功率, 自定义metrics(可以直接配置prometheus PQL)等</p>
<p>- webhook:可以用来人工审核接入, 压力测试等.</p>
<p>- alerts: 进度详情, 告警通知等</p>
<h3 id="flagger-工作流程"><a href="#flagger-工作流程" class="headerlink" title="flagger 工作流程"></a>flagger 工作流程</h3> <img src="/images/flagger 流程.png" alt="flagger 流程" style="zoom:80%;" />



<p>！核心：webhook——人工干预，实现暂停、回滚、继续、策略调整</p>
<h2 id="部署策略"><a href="#部署策略" class="headerlink" title="部署策略"></a>部署策略</h2><h3 id="A-B-testing"><a href="#A-B-testing" class="headerlink" title="A/B testing"></a>A/B testing</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">analysis:</span></span><br><span class="line">    <span class="comment"># schedule interval (default 60s)</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="comment"># total number of iterations</span></span><br><span class="line">    <span class="attr">iterations:</span> <span class="number">10</span></span><br><span class="line">    <span class="comment"># max number of failed iterations before rollback</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># canary match condition</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">          <span class="attr">x-canary:</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">&quot;.*insider.*&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">          <span class="attr">cookie:</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">&quot;^(.*?;)?(canary=always)(;.*)?$&quot;</span></span><br></pre></td></tr></table></figure>

<p>以上面代码示例为例:<br>• 会在创建VirtualService过(istio)程中, 设置多个HTTPRoute.<br>• 默认流量, 访问primary service<br>• 通过http header或者cookie 正则匹配方式, 将流量路由到canary service.<br>• 整个流程会执行10次，每次间隔1分钟, 最多允许2次metrics验证失败. 如果超过2次, 则进行回滚.<br>• 正常结束后, 会执行”confirm-promotion” webhook, 确认是否将primary替换成cannay</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">• 如果是, 会将primary替换成cananry的spec(deployemnt spec, configmap)相关信息</span><br><span class="line">• 如果否, 继续等待</span><br></pre></td></tr></table></figure>



<h3 id="Blue-Green"><a href="#Blue-Green" class="headerlink" title="Blue/Green"></a>Blue/Green</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">analysis:</span></span><br><span class="line">   <span class="comment"># schedule interval (default 60s)</span></span><br><span class="line">   <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">   <span class="comment"># total number of iterations</span></span><br><span class="line">   <span class="attr">iterations:</span> <span class="number">10</span></span><br><span class="line">   <span class="comment"># max number of failed iterations before rollback</span></span><br><span class="line">   <span class="attr">threshold:</span> <span class="number">2</span></span><br><span class="line">   <span class="attr">webhooks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;load test&quot;</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">rollout</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">http://flagger-loadtester.test/</span></span><br><span class="line">      <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">cmd:</span> <span class="string">&quot;hey -z 1m -q 10 -c 2 http://podinfo.test:9898/&quot;</span></span><br></pre></td></tr></table></figure>

<p>以上面代码示例为例:<br>• 整个流程会执行10次，每次间隔1分钟, 最多允许2次metrics验证失败.如果超过2次, 则进行回滚.<br>• 在这段时间会对canary service进行压力测试<br>• 正常结束后, 会执行”confirm-promotion” webhook, 确认是否将primary替换成cannay</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">• 如果是, 会将primary替换成cananry的spec(deployemnt spec, configmap)相关信息</span><br><span class="line">• 如果否, 继续等待</span><br></pre></td></tr></table></figure>

<p>如果配置了mirror=true(只有provider=istio时才支持该特性), 则会使用istio的mirror特性, 将流量分别copy 到primary和canary, 使用primary的reponse作为返回值. 这个时候要特别注意业务是否幂等.</p>
<h3 id="Canary"><a href="#Canary" class="headerlink" title="Canary"></a>Canary</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">analysis:</span></span><br><span class="line">    <span class="comment"># schedule interval (default 60s)</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="comment"># max number of failed metric checks before rollback</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># max traffic percentage routed to canary</span></span><br><span class="line">    <span class="comment"># percentage (0-100)</span></span><br><span class="line">    <span class="attr">maxWeight:</span> <span class="number">50</span></span><br><span class="line">    <span class="comment"># canary increment step</span></span><br><span class="line">    <span class="comment"># percentage (0-100)</span></span><br><span class="line">    <span class="attr">stepWeight:</span> <span class="number">2</span></span><br><span class="line">  <span class="comment"># deploy straight to production without</span></span><br><span class="line">  <span class="comment"># the metrics and webhook checks</span></span><br><span class="line">  <span class="attr">skipAnalysis:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>以上面代码示例为例:<br>• 整个流程会执行25(maxWeight/maxWeight)次，每次间隔1分钟, 最多允许2次metrics验证失败.如果超过2次, 则进行回滚.<br>• 每次primary减少stepWeight%流量, canary增加stepWeight%流量, 直到canary到达maxWeight<br>• 执行”confirm-promotion” webhook, 确认是否将primary替换成cannay</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">• 如果是, 会将primary替换成cananry的spec(deployemnt spec, configmap)相关信息</span><br><span class="line">• 如果否, 继续等待</span><br></pre></td></tr></table></figure>



<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="Webhooks"><a href="#Webhooks" class="headerlink" title="Webhooks"></a>Webhooks</h3><p>webhooks: 在整个发布过程中, 定义了相应的扩展点:<br>• confirm-rollout: 在canary接收流量之前执行. 可以用于人工审核发布, 自动化测试通过等场景.<br>如果该webhook没有返回成功(例如:请求返回状态码200), 则发布一直等待.<br>• pre-rollout: 在第一次切流到canary前执行的webhook. 如果执行失败次数超过阀值, 则进行回滚<br>• rollout: 在发布的每个周期(例如每个stepWeight)中的metrics分析之前执行.如果执行失败次数超过阀值, 则进行回滚<br>• confirm-promotion: 在primary变更到canary配置相关信息之前执行.<br>如果不成功, 会一直等待.在等待的过程中, Flagger会继续执行metrics验证直到最终回滚.<br>• post-rollout: 在rollback或者finish后执行. 如果执行失败只会记录Event日志。<br>• rollback: 当Canary处于Progressing或者Waiting状态时. 提供人工执行回滚的能力.<br>• event: 在每个生命周期,都会产生一些相关k8s event. 如果配置event webhook, 则在产生k8s event的同时，发送相关event事件信息.</p>
<h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h3><p>Metrics: 用于决策(A/B, Blue/Green, Canary)流量是否验证失败, 超过制定阀值(threshold)就会回滚发布<br>• 缺省自带的metrics</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">analysis:</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">request-success-rate</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">      <span class="comment"># minimum req success rate (non 5xx responses)</span></span><br><span class="line">      <span class="comment"># percentage (0-100)</span></span><br><span class="line">      <span class="attr">thresholdRange:</span></span><br><span class="line">        <span class="attr">min:</span> <span class="number">99</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">request-duration</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">1m</span></span><br><span class="line">      <span class="comment"># maximum req duration P99</span></span><br><span class="line">      <span class="comment"># milliseconds</span></span><br><span class="line">      <span class="attr">thresholdRange:</span></span><br><span class="line">        <span class="attr">max:</span> <span class="number">500</span></span><br></pre></td></tr></table></figure>

<ul>
<li>request-success-rate(请求成功率). 上例说明成功率不能低于99%</li>
<li>request-duration(avg RT): RT均值不能超过500ms<br>request-success-rate和request-duration是Flagger缺省自带的metrics.</li>
</ul>
<p>不同的provider有不通实现. 例如:应用可以提供prometheus metrics</p>
<p>• 自定义metrics</p>
<ol>
<li>创建MetricTemplate. 比如业务自定义的业务metrics, 如订单支付失败率</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flagger.app/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MetricTemplate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">not-found-percentage</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">provider:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">address:</span> <span class="string">http://promethues.istio-system:9090</span></span><br><span class="line">  <span class="attr">query:</span> <span class="string">|</span></span><br><span class="line">    <span class="number">100</span> <span class="bullet">-</span> <span class="string">sum(</span></span><br><span class="line">        <span class="string">rate(</span></span><br><span class="line">            <span class="string">istio_requests_total&#123;</span></span><br><span class="line">              <span class="string">reporter=&quot;destination&quot;,</span></span><br><span class="line">              <span class="string">destination_workload_namespace=&quot;&#123;&#123;</span> <span class="string">namespace</span> <span class="string">&#125;&#125;&quot;,</span></span><br><span class="line">              <span class="string">destination_workload=&quot;&#123;&#123;</span> <span class="string">target</span> <span class="string">&#125;&#125;&quot;,</span></span><br><span class="line">              <span class="string">response_code!=&quot;404&quot;</span></span><br><span class="line">            <span class="string">&#125;[&#123;&#123;</span> <span class="string">interval</span> <span class="string">&#125;&#125;]</span></span><br><span class="line">        <span class="string">)</span></span><br><span class="line">    <span class="string">)</span></span><br><span class="line">    <span class="string">/</span></span><br><span class="line">    <span class="string">sum(</span></span><br><span class="line">        <span class="string">rate(</span></span><br><span class="line">            <span class="string">istio_requests_total&#123;</span></span><br><span class="line">              <span class="string">reporter=&quot;destination&quot;,</span></span><br><span class="line">              <span class="string">destination_workload_namespace=&quot;&#123;&#123;</span> <span class="string">namespace</span> <span class="string">&#125;&#125;&quot;,</span></span><br><span class="line">              <span class="string">destination_workload=&quot;&#123;&#123;</span> <span class="string">target</span> <span class="string">&#125;&#125;&quot;</span></span><br><span class="line">            <span class="string">&#125;[&#123;&#123;</span> <span class="string">interval</span> <span class="string">&#125;&#125;]</span></span><br><span class="line">        <span class="string">)</span></span><br><span class="line">    <span class="string">)</span> <span class="string">*</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>引用MetricTemplate</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">analysis:</span></span><br><span class="line">   <span class="attr">metrics:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;404s percentage&quot;</span></span><br><span class="line"> <span class="attr">templateRef:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">not-found-percentage</span></span><br><span class="line">   <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"> <span class="attr">thresholdRange:</span></span><br><span class="line">   <span class="attr">max:</span> <span class="number">5</span></span><br><span class="line"> <span class="attr">interval:</span> <span class="string">1m</span></span><br></pre></td></tr></table></figure>

<p>上例表示canary的关于404错误/s的metrics不能超过5%</p>
</li>
</ol>
<h3 id="Alter"><a href="#Alter" class="headerlink" title="Alter"></a>Alter</h3><p>Alter: 用于发布过程中信息通知.<br>1.定义AlterProvider(可以是slack, 也可以是dingding)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">flagger.app/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AlertProvider</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">on-call</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">flagger</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">slack</span></span><br><span class="line">  <span class="attr">channel:</span> <span class="string">on-call-alerts</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">flagger</span></span><br><span class="line">  <span class="comment"># webhook address (ignored if secretRef is specified)</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK</span></span><br><span class="line">  <span class="comment"># secret containing the webhook address (optional)</span></span><br><span class="line">  <span class="attr">secretRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">on-call-url</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>	</span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">on-call-url</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">flagger</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">&lt;encoded-url&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.使用Alter</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">analysis:</span></span><br><span class="line">    <span class="attr">alerts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;on-call Slack&quot;</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">error</span></span><br><span class="line">        <span class="attr">providerRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">on-call</span></span><br><span class="line">          <span class="attr">namespace:</span> <span class="string">flagger</span></span><br></pre></td></tr></table></figure>

<p>• serverity: 通知信息的等级, 类似日志级别. 包含info, warn, error<br>在整个部署过程中，不同阶段都会使用alter来发送通知信息, 例如发布成功, webhook执行失败等场景。</p>
<p>！使用 flagger 保证 0 宕机 所需 <code>注意点</code> ：</p>
<ul>
<li><p>Deployment的重启策略必须为 RollingUpdate，且</p>
</li>
<li><p>Liveness/Readiness  健康检测需要添加</p>
</li>
<li><p>Graceful shutdown 必须设置</p>
</li>
<li><p>使用 资源申请和上限 限制</p>
</li>
</ul>
<h4 id="限制："><a href="#限制：" class="headerlink" title="限制："></a>限制：</h4><p>单纯 kubernetes CNI 仅支持 蓝绿发布</p>
<h4 id="额外发布支持："><a href="#额外发布支持：" class="headerlink" title="额外发布支持："></a>额外发布支持：</h4><p>NGINX 支持 金丝雀、A/B、蓝绿发布</p>
<p>ISTIO 所有发布类型支持</p>
<hr>
<p>发布策略、动作支持 核心</p>
<h2 id="webhook"><a href="#webhook" class="headerlink" title="webhook"></a>webhook</h2><p>支持以下</p>
<ul>
<li>确认发布——confirm rollout（确认发布将开始）</li>
<li>预发布——pre-rollout（发布开始时确认动作）</li>
<li>发布每一步——rollout（每次发布变更步骤执行）</li>
<li>确认发布生效——confirm-promotion（确认发布将生效）</li>
<li>预生效——post-rollout（每次生效时确认动作）</li>
<li>回退——rollback（处于 <code>发布中</code> /<code>等待中</code>  状态时可以执行回滚）</li>
<li>事件——event（发布过程中，发布相关事件都可以被监听，来执行对应的策略）</li>
</ul>
<p>参考连接</p>
<p><a target="_blank" rel="noopener" href="https://docs.flagger.app/usage/webhooks">https://docs.flagger.app/usage/webhooks</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-03-08T16:02:14.000Z" title="3/9/2021, 12:02:14 AM">2021-03-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-03-08T08:27:24.787Z" title="3/8/2021, 4:27:24 PM">2021-03-08</time></span><span class="level-item"><a class="link-muted" href="/categories/distribution/">distribution</a></span><span class="level-item">10 minutes read (About 1555 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/09/ceph-%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">ceph 入门笔记</a></h1><div class="content"><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>分布式存储系统</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过网络将数据分散存储在多台独立的设备上。</span><br></pre></td></tr></table></figure>





<p>特性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">可扩展性</span><br><span class="line">可扩展至 百台甚至千台的集群规模，随着集群规模增长，系统整体性能表现为 线性增长。</span><br><span class="line"></span><br><span class="line">  水平扩展有以下特性：</span><br><span class="line">  1）节点扩展后，旧数据自动迁移到新节点，实现负载均衡，避免单节点过热；</span><br><span class="line">  2）水平扩展只需要将新节点和原有集群连接到同一网络，整个过程不会对业务造成影响；</span><br><span class="line">  3）当节点被添加到集群，集群的整体容量和性能也随之线性扩展。之后，新节点资源就被管理平台接管，用于分配 或 回收</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">低成本</span><br><span class="line">自动容错、自动负载均衡机制，可构建于普通的PC机上。机器增加、减少方便，自动运维。</span><br><span class="line"></span><br><span class="line">高性能</span><br><span class="line">单服务器/集群，要求具备高性能。</span><br><span class="line"></span><br><span class="line">易用</span><br><span class="line">可提供易用对外接口，要求完善的监控、运维工具。可与现有系统集成。</span><br><span class="line"></span><br><span class="line">易管理</span><br><span class="line">通过一个简单的 WEB 界面对整个系统进行配置管理、运维操作。</span><br><span class="line"></span><br><span class="line">挑战：</span><br><span class="line">在于数据、状态信息的持久化，要求在自动迁移、自动容错、并发读写的过程中保证数据的一致性。</span><br><span class="line">涉及技术主要来自两个领域：分布式系统 &amp;&amp; 数据库。</span><br></pre></td></tr></table></figure>



<p>存储分类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">本地存储文件的文件系统，不能在网络上使用</span><br><span class="line">	ext3	ext4	xfs	 ntfs</span><br><span class="line"></span><br><span class="line">网络存储——网络文件系统，共享的都是文件系统</span><br><span class="line">	nfs					网络文件系统</span><br><span class="line">	hdfs				分布式网络文件系统</span><br><span class="line">	glusterfs		分布式网络文件系统</span><br><span class="line">	</span><br><span class="line">共享的是裸设备</span><br><span class="line">	块存储 cinder	ceph（块存储	对象存储	网络文件系统-分布式）</span><br><span class="line">	SAN（存储区域网）——存储与服务器间使用光纤交换机去连接，组成专用存储网络</span><br><span class="line">	</span><br><span class="line">分布式</span><br><span class="line">		集群</span><br><span class="line">											client</span><br><span class="line">											   |</span><br><span class="line">											namenode       元数据服务器</span><br><span class="line">												 |</span><br><span class="line">				------------------------------------</span><br><span class="line">				|                |                 |</span><br><span class="line">     datanode         datanode          datanode</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">任何文件系统中的数据，都分为 数据 和 元数据</span><br><span class="line">数据：文件中实际内容</span><br><span class="line">元数据：描述文件特征，文件类型、数据块分布信息（磁盘位置）等，用于定位和访问数据</span><br></pre></td></tr></table></figure>



<h3 id="ceph"><a href="#ceph" class="headerlink" title="ceph"></a>ceph</h3><h4 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h4><p>可避免单节点故障的分布式文件系统，PB级别的扩展能力。提供较好的性能、可扩展性和可靠性</p>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><p>高扩展性</p>
<p>使用普通X86服务器，支持 10~1000台服务器，支持TB到EB级的扩展</p>
<p>高可靠性</p>
<p>没有单点故障，多数据副本，自动管理，自动修复</p>
<p>高性能</p>
<p>数据分布均衡</p>
<p>可用于对象存储、块设备存储和文件系统存储</p>
<h4 id="ceph-架构"><a href="#ceph-架构" class="headerlink" title="ceph 架构"></a>ceph 架构</h4><p><img src="/Users/pauljobs/Documents/ceph%E6%9E%B6%E6%9E%84.png" alt="ceph架构"></p>
<p>基础存储系统 RADOS</p>
<p>Reliable，Autonomic，Distributed Object Store，即可靠、自动化、分布式对象存储。所有ceph系统中的用户数据事实上最终都来源这一层来存储。上述特性也由这一层提供。</p>
<p>基础库 librados</p>
<p>对  <code>RADOS</code> 进行抽象和封装，并向上提供API，以便直接基于RADOS进行应用开发。！RADOS是一个对象存储系统。</p>
<p>高层应用接口</p>
<p>radosgw：对象网关接口（对象存储）</p>
<p>rbd：块存储</p>
<p>cephfs：文件系统存储</p>
<p>效果/作用：提供在librados库的基础上，提供抽象层次更高、更便于应用或客户端使用的上层接口。</p>
<h3 id="ceph组件"><a href="#ceph组件" class="headerlink" title="ceph组件"></a>ceph组件</h3><p><img src="/Users/pauljobs/Documents/ceph%E7%BB%84%E4%BB%B6.png" alt="ceph组件"></p>
<p>三个主要进程</p>
<h4 id="OSD"><a href="#OSD" class="headerlink" title="OSD"></a>OSD</h4><p>用于集群中所有数据与对象的存储。处理集群数据的复制、恢复、回填、再均衡。并向其他 OSD 守护进程发送心跳，然后向 MON 提供一些监控信息。</p>
<p>当ceph存储集群设定数据有两个副本时（一共存两份），至少需要两个OSD守护进程即两个OSD节点，集群才能达到 active+clean状态。</p>
<h4 id="MDS（可选）"><a href="#MDS（可选）" class="headerlink" title="MDS（可选）"></a>MDS（可选）</h4><p>为 ceph 文件系统提供元数据计算、缓存与同步（ceph RBD、对象存储不使用MDS）。元数据也是存储在OSD节点中的，MDS类似元数据的代理缓存服务器。MDS进程并不是必须的进程，只有需要CEPHFS时，才需要配置MDS节点。</p>
<h4 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h4><p>监控整个集群的状态，维护集群的cluster MAP二进制表，保证集群数据的一致性。ClusterMAP 描述了对象块存储的物理位置，以及一个将设备聚合到物理位置的桶列表。</p>
<h4 id="Manager（ceph-mgr）"><a href="#Manager（ceph-mgr）" class="headerlink" title="Manager（ceph-mgr）"></a>Manager（ceph-mgr）</h4><p>用于收集 ceph 集群状态、运行指标，比如存储利用率、当前性能指标和系统负载。对外提供 ceph dashboard（ceph ui）和 restful api。Manager组件开启高可用时，至少 2 个。</p>
<p>ceph结构——两部分：client 和 node</p>
<p>ceph client：访问ceph底层服务和组件，对外提供各种接口。比如：对象存储接口、块存储接口、文件系统存储接口。</p>
<p>ceph node：ceph底层服务提供端，也就是 ceph 存储集群。</p>
<p>什么是OSD</p>
<p>对象存储（Object-based Storage）是一种新的网络存储结构，基于对象存储技术的设备就是对象存储设备（Object-based Storage Device），简称OSD。总体上来说，对象存储结合了 NAS 和 SAN 的优点，同时具有 SAN 的高速直接访问和NAS的分布式数据共享等优势，提供了具有高性能、高可靠性、跨平台以及安全的数据共享的存储结构体系。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-03-08T16:00:16.000Z" title="3/9/2021, 12:00:16 AM">2021-03-08</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-03-08T08:01:45.926Z" title="3/8/2021, 4:01:45 PM">2021-03-08</time></span><span class="level-item"><a class="link-muted" href="/categories/container/">container</a></span><span class="level-item">14 minutes read (About 2105 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/09/docker-pull%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/">docker pull问题排查</a></h1><div class="content"><p>1、首先docker日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Jul 16 14:41:46 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:41:46.453596079+08:00&quot; level&#x3D;error msg&#x3D;&quot;Download failed, retrying: unexpected EOF&quot;</span><br><span class="line">Jul 16 14:42:06 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:42:06.483391207+08:00&quot; level&#x3D;error msg&#x3D;&quot;Download failed: unexpected EOF&quot;</span><br><span class="line">Jul 16 14:42:29 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:42:29.220439089+08:00&quot; level&#x3D;warning msg&#x3D;&quot;Error getting v2 registry: Get https:&#x2F;&#x2F;af.hikvision.com.cn&#x2F;v2&#x2F;: dial tcp: lookup af.hikvision.com.cn on</span><br><span class="line">Jul 16 14:42:29 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:42:29.245091739+08:00&quot; level&#x3D;warning msg&#x3D;&quot;Error getting v2 registry: Get http:&#x2F;&#x2F;af.hikvision.com.cn&#x2F;v2&#x2F;: dial tcp: lookup af.hikvision.com.cn on </span><br><span class="line">Jul 16 14:42:29 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:42:29.245196494+08:00&quot; level&#x3D;error msg&#x3D;&quot;Handler for POST &#x2F;images&#x2F;create returned error: Get http:&#x2F;&#x2F;af.hikvision.com.cn&#x2F;v2&#x2F;: dial tcp: lookup af.h</span><br><span class="line">Jul 16 14:46:33 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:46:33.972502089+08:00&quot; level&#x3D;error msg&#x3D;&quot;Download failed, retrying: unexpected EOF&quot;</span><br><span class="line">Jul 16 14:46:38 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:46:38.999069663+08:00&quot; level&#x3D;error msg&#x3D;&quot;Download failed, retrying: unexpected EOF&quot;</span><br><span class="line">Jul 16 14:46:49 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:46:49.014718214+08:00&quot; level&#x3D;error msg&#x3D;&quot;Download failed, retrying: unexpected EOF&quot;</span><br><span class="line">Jul 16 14:47:04 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:47:04.041825197+08:00&quot; level&#x3D;error msg&#x3D;&quot;Download failed, retrying: unexpected EOF&quot;</span><br><span class="line">Jul 16 14:47:24 worker1 dockerd[2396]: time&#x3D;&quot;2020-07-16T14:47:24.070685084+08:00&quot; level&#x3D;error msg&#x3D;&quot;Download failed: unexpected EOF&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、修改域名解析问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nameserver 114.114.114.114</span><br><span class="line">nameserver 10.96.0.10</span><br><span class="line">nameserver 10.1.7.77</span><br><span class="line">nameserver 10.1.7.97</span><br><span class="line">nameserver 10.1.7.98</span><br><span class="line">nameserver 10.1.7.88</span><br></pre></td></tr></table></figure>



<p>修改为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameserver 10.1.7.98</span><br></pre></td></tr></table></figure>



<p>3、查看harbor日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">命令：</span><br><span class="line">k logs harbor-harbor-registry-68c9db8d9c-m76x8 -c registry --tail&#x3D;100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">10.19.123.165 - - [16&#x2F;Jul&#x2F;2020:07:30:39 +0000] &quot;GET &#x2F;v2 HTTP&#x2F;1.1&quot; 301 39 &quot;&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:39.192445209Z&quot; level&#x3D;debug msg&#x3D;&quot;authorizing request&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;ce22d938-3e7e-4164-b1c8-0d312306a6e0 http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;10.19.123.165:7611&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:39.192513529Z&quot; level&#x3D;warning msg&#x3D;&quot;error authorizing context: authorization token required&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;ce22d938-3e7e-4164-b1c8-0d312306a6e0 http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;10.19.123.165:7611&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">10.19.123.165 - - [16&#x2F;Jul&#x2F;2020:07:30:39 +0000] &quot;GET &#x2F;v2&#x2F; HTTP&#x2F;1.1&quot; 401 87 &quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br><span class="line">172.30.5.3 - - [16&#x2F;Jul&#x2F;2020:07:30:47 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 0 &quot;&quot; &quot;kube-probe&#x2F;1.17&quot;</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:47.219604256Z&quot; level&#x3D;info msg&#x3D;&quot;response completed&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;736a16dc-64c3-4aff-98d3-c091919b9665 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;&quot;172.30.5.2:30577&quot; http.request.uri&#x3D;&quot;&#x2F;v2&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; http.response.contenttype&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; http.response.duration&#x3D;&quot;85.835µs&quot; http.response.status&#x3D;301 http.response.written&#x3D;39 </span><br><span class="line">172.30.5.2 - - [16&#x2F;Jul&#x2F;2020:07:30:47 +0000] &quot;GET &#x2F;v2 HTTP&#x2F;1.1&quot; 301 39 &quot;&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:47.221183139Z&quot; level&#x3D;debug msg&#x3D;&quot;authorizing request&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;ccd84eed-8eee-4585-b861-e6fef8e95cc4 http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;172.30.5.2:30577&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:47.221269133Z&quot; level&#x3D;warning msg&#x3D;&quot;error authorizing context: authorization token required&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;ccd84eed-8eee-4585-b861-e6fef8e95cc4 http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;172.30.5.2:30577&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">172.30.5.2 - - [16&#x2F;Jul&#x2F;2020:07:30:47 +0000] &quot;GET &#x2F;v2&#x2F; HTTP&#x2F;1.1&quot; 401 87 &quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br><span class="line">172.30.5.3 - - [16&#x2F;Jul&#x2F;2020:07:30:47 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 0 &quot;&quot; &quot;kube-probe&#x2F;1.17&quot;</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:49.190353024Z&quot; level&#x3D;info msg&#x3D;&quot;response completed&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;6e4083f2-529c-4c35-b07e-99afeb491aa7 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;&quot;10.19.123.165:63600&quot; http.request.uri&#x3D;&quot;&#x2F;v2&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; http.response.contenttype&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; http.response.duration&#x3D;&quot;108.978µs&quot; http.response.status&#x3D;301 http.response.written&#x3D;39 </span><br><span class="line">10.19.123.165 - - [16&#x2F;Jul&#x2F;2020:07:30:49 +0000] &quot;GET &#x2F;v2 HTTP&#x2F;1.1&quot; 301 39 &quot;&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:49.191510503Z&quot; level&#x3D;debug msg&#x3D;&quot;authorizing request&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;c33522c3-2afb-4a8f-b422-e60b5aeae7af http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;10.19.123.165:63600&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:49.191572656Z&quot; level&#x3D;warning msg&#x3D;&quot;error authorizing context: authorization token required&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;c33522c3-2afb-4a8f-b422-e60b5aeae7af http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;10.19.123.165:63600&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">10.19.123.165 - - [16&#x2F;Jul&#x2F;2020:07:30:49 +0000] &quot;GET &#x2F;v2&#x2F; HTTP&#x2F;1.1&quot; 401 87 &quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br><span class="line">172.30.5.3 - - [16&#x2F;Jul&#x2F;2020:07:30:57 +0000] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 0 &quot;&quot; &quot;kube-probe&#x2F;1.17&quot;</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:57.219890218Z&quot; level&#x3D;info msg&#x3D;&quot;response completed&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;b463ef5e-7723-4a94-90e1-ca1163550553 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;&quot;172.30.5.2:8799&quot; http.request.uri&#x3D;&quot;&#x2F;v2&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; http.response.contenttype&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; http.response.duration&#x3D;&quot;178.483µs&quot; http.response.status&#x3D;301 http.response.written&#x3D;39 </span><br><span class="line">172.30.5.2 - - [16&#x2F;Jul&#x2F;2020:07:30:57 +0000] &quot;GET &#x2F;v2 HTTP&#x2F;1.1&quot; 301 39 &quot;&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:57.221293323Z&quot; level&#x3D;debug msg&#x3D;&quot;authorizing request&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;a3964e76-656f-4b74-b1a7-18d72ece4d39 http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;172.30.5.2:8799&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:30:57.221359025Z&quot; level&#x3D;warning msg&#x3D;&quot;error authorizing context: authorization token required&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;harbor-harbor-registry:9188&quot; http.request.id&#x3D;a3964e76-656f-4b74-b1a7-18d72ece4d39 http.request.method&#x3D;GET http.request.referer&#x3D;&quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; http.request.remoteaddr&#x3D;&quot;172.30.5.2:8799&quot; http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;&quot; http.request.useragent&#x3D;&quot;Go-http-client&#x2F;1.1&quot; </span><br><span class="line">172.30.5.2 - - [16&#x2F;Jul&#x2F;2020:07:30:57 +0000] &quot;GET &#x2F;v2&#x2F; HTTP&#x2F;1.1&quot; 401 87 &quot;http:&#x2F;&#x2F;harbor-harbor-registry:9188&#x2F;v2&quot; &quot;Go-http-client&#x2F;1.1&quot;</span><br></pre></td></tr></table></figure>

<p>harbor运行正常</p>
<p>4、harbor</p>
<p>文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;opt&#x2F;hikcloud&#x2F;harbor&#x2F;registry&#x2F;docker&#x2F;registry&#x2F;v2&#x2F;repositories&#x2F;docker-pbg&#x2F;ydic&#x2F;_layers&#x2F;sha256</span><br><span class="line"></span><br><span class="line">ll查看 失败layer存在</span><br></pre></td></tr></table></figure>



<p>5、nginx-controller</p>
<p>查看nginx日志</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">2020&#x2F;07&#x2F;16 07:22:36 [error] 2043#2043: *197739729 upstream prematurely closed connection while reading upstream, client: 172.30.5.3, server: docker.hikcloud, request: &quot;GET &#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db HTTP&#x2F;1.1&quot;, upstream: &quot;http:&#x2F;&#x2F;172.30.5.3:9185&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot;, host: &quot;docker.hikcloud:30001&quot;</span><br><span class="line">172.30.5.3 - - [16&#x2F;Jul&#x2F;2020:07:22:36 +0000] &quot;GET &#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db HTTP&#x2F;1.1&quot; 200 0 &quot;-&quot; &quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; 1465 0.016 [kube-system-harbor-harbor-core-80] [] 172.30.5.3:9185 0 0.017 200 ce6fa0910582345c45ded8d5b25ae0d3</span><br><span class="line">2020&#x2F;07&#x2F;16 07:22:45 [error] 2046#2046: *197739952 upstream prematurely closed connection while reading upstream, client: 172.30.5.3, server: docker.hikcloud, request: &quot;GET &#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db HTTP&#x2F;1.1&quot;, upstream: &quot;http:&#x2F;&#x2F;172.30.5.2:9185&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot;, host: &quot;docker.hikcloud:30001&quot;</span><br><span class="line">172.30.5.3 - - [16&#x2F;Jul&#x2F;2020:07:22:45 +0000] &quot;GET &#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db HTTP&#x2F;1.1&quot; 200 0 &quot;-&quot; &quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; 1465 0.015 [kube-system-harbor-harbor-core-80] [] 172.30.5.2:9185 0 0.014 200 54a5962ae803cfaf593c720b4d8f4171</span><br><span class="line">2020&#x2F;07&#x2F;16 07:22:51 [error] 2049#2049: *197740104 upstream prematurely closed connection while reading upstream, client: 172.30.5.3, server: docker.hikcloud, request: &quot;GET &#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db HTTP&#x2F;1.1&quot;, upstream: &quot;http:&#x2F;&#x2F;172.30.5.2:9185&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot;, host: &quot;docker.hikcloud:30001&quot;</span><br><span class="line">172.30.5.3 - - [16&#x2F;Jul&#x2F;2020:07:22:51 +0000] &quot;GET &#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db HTTP&#x2F;1.1&quot; 200 0 &quot;-&quot; &quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; 1465 0.025 [kube-system-harbor-harbor-core-80] [] 172.30.5.2:9185 0 0.025 200 12d8f488258785ebf59bbae48881c3de</span><br><span class="line">[root@worker1 ~]# kubectl logs --tail&#x3D;100 -n kube-system harbor-harbor-registry-68c9db8d9c-m76x8 -c registry | grep 674</span><br><span class="line">time&#x3D;&quot;2020-07-16T07:23:11.349040402Z&quot; level&#x3D;debug msg&#x3D;&quot;authorizing request&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;docker.hikcloud:30001&quot; http.request.id&#x3D;39de630c-307d-4ae0-9d98-d86ba76303e0 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;172.30.5.2 http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; http.request.useragent&#x3D;&quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; vars.digest&#x3D;&quot;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; vars.name&#x3D;&quot;docker-pbg&#x2F;ydic&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:23:11.349875921Z&quot; level&#x3D;info msg&#x3D;&quot;authorized request&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;docker.hikcloud:30001&quot; http.request.id&#x3D;39de630c-307d-4ae0-9d98-d86ba76303e0 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;172.30.5.2 http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; http.request.useragent&#x3D;&quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; vars.digest&#x3D;&quot;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; vars.name&#x3D;&quot;docker-pbg&#x2F;ydic&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:23:11.349994691Z&quot; level&#x3D;debug msg&#x3D;GetBlob auth.user.name&#x3D; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;docker.hikcloud:30001&quot; http.request.id&#x3D;39de630c-307d-4ae0-9d98-d86ba76303e0 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;172.30.5.2 http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; http.request.useragent&#x3D;&quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; vars.digest&#x3D;&quot;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; vars.name&#x3D;&quot;docker-pbg&#x2F;ydic&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:23:11.353393785Z&quot; level&#x3D;debug msg&#x3D;&quot;filesystem.URLFor(&quot;&#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;67&#x2F;674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&#x2F;data&quot;)&quot; auth.user.name&#x3D; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;docker.hikcloud:30001&quot; http.request.id&#x3D;39de630c-307d-4ae0-9d98-d86ba76303e0 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;172.30.5.2 http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; http.request.useragent&#x3D;&quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; trace.duration&#x3D;36.014µs trace.file&#x3D;&quot;&#x2F;go&#x2F;src&#x2F;github.com&#x2F;docker&#x2F;distribution&#x2F;registry&#x2F;storage&#x2F;driver&#x2F;base&#x2F;base.go&quot; trace.func&#x3D;&quot;github.com&#x2F;docker&#x2F;distribution&#x2F;registry&#x2F;storage&#x2F;driver&#x2F;base.(*Base).URLFor&quot; trace.id&#x3D;587d96eb-1aae-4d8d-8abc-cc0cc0c3d972 trace.line&#x3D;217 vars.digest&#x3D;&quot;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; vars.name&#x3D;&quot;docker-pbg&#x2F;ydic&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:23:11.36010056Z&quot; level&#x3D;debug msg&#x3D;&quot;filesystem.Reader(&quot;&#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;67&#x2F;674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&#x2F;data&quot;, 0)&quot; auth.user.name&#x3D; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;docker.hikcloud:30001&quot; http.request.id&#x3D;39de630c-307d-4ae0-9d98-d86ba76303e0 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;172.30.5.2 http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; http.request.useragent&#x3D;&quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; trace.duration&#x3D;6.584606ms trace.file&#x3D;&quot;&#x2F;go&#x2F;src&#x2F;github.com&#x2F;docker&#x2F;distribution&#x2F;registry&#x2F;storage&#x2F;driver&#x2F;base&#x2F;base.go&quot; trace.func&#x3D;&quot;github.com&#x2F;docker&#x2F;distribution&#x2F;registry&#x2F;storage&#x2F;driver&#x2F;base.(*Base).Reader&quot; trace.id&#x3D;bc92eae0-665a-42e5-8a2b-42a69ce3b03c trace.line&#x3D;125 vars.digest&#x3D;&quot;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; vars.name&#x3D;&quot;docker-pbg&#x2F;ydic&quot; </span><br><span class="line">time&#x3D;&quot;2020-07-16T07:23:11.361415935Z&quot; level&#x3D;info msg&#x3D;&quot;response completed&quot; go.version&#x3D;go1.11.8 http.request.host&#x3D;&quot;docker.hikcloud:30001&quot; http.request.id&#x3D;39de630c-307d-4ae0-9d98-d86ba76303e0 http.request.method&#x3D;GET http.request.remoteaddr&#x3D;172.30.5.2 http.request.uri&#x3D;&quot;&#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db&quot; http.request.useragent&#x3D;&quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot; http.response.contenttype&#x3D;&quot;application&#x2F;octet-stream&quot; http.response.duration&#x3D;14.387271ms http.response.status&#x3D;200 http.response.written&#x3D;0 </span><br><span class="line">172.30.5.2 - - [16&#x2F;Jul&#x2F;2020:07:23:11 +0000] &quot;GET &#x2F;v2&#x2F;docker-pbg&#x2F;ydic&#x2F;blobs&#x2F;sha256:674a59b4e199228c78a5882ede113516d45d2eadac407f1828d03dda775875db HTTP&#x2F;1.1&quot; 200 0 &quot;&quot; &quot;docker&#x2F;19.03.4 go&#x2F;go1.12.10 git-commit&#x2F;9013bf583a kernel&#x2F;3.10.0-1062.18.1.el7.x86_64 os&#x2F;linux arch&#x2F;amd64 UpstreamClient(Go-http-client&#x2F;1.1)&quot;</span><br></pre></td></tr></table></figure>





<p>upstream prematurely closed connection while reading upstream</p>
<p>错误原因：后端服务异常</p>
</div></article></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/1.jpg" alt="wikix"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">wikix</p><p class="is-size-6 is-block">System developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou (ZH)</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">4</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">4</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/wikix" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/wikix"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gmail" href="/wikiios145@gmail.com"><i class="fab fa-google"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://github.com/wikix" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/container/"><span class="level-start"><span class="level-item">container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/distribution/"><span class="level-start"><span class="level-item">distribution</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/kubernetes-container/"><span class="level-start"><span class="level-item">kubernetes, container</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/network/"><span class="level-start"><span class="level-item">network</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-08T16:17:05.000Z">2021-03-08</time></p><p class="title"><a href="/2021/03/09/TCP-IP-%E7%9F%A5%E8%AF%86%E7%82%B9/">TCP/IP 知识点</a></p><p class="categories"><a href="/categories/network/">network</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-08T16:06:40.000Z">2021-03-08</time></p><p class="title"><a href="/2021/03/09/flagger-%E8%A7%A3%E6%9E%90/">flagger 解析</a></p><p class="categories"><a href="/categories/kubernetes-container/">kubernetes, container</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-08T16:02:14.000Z">2021-03-08</time></p><p class="title"><a href="/2021/03/09/ceph-%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">ceph 入门笔记</a></p><p class="categories"><a href="/categories/distribution/">distribution</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-08T16:00:16.000Z">2021-03-08</time></p><p class="title"><a href="/2021/03/09/docker-pull%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/">docker pull问题排查</a></p><p class="categories"><a href="/categories/container/">container</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ceph-storage/"><span class="tag">ceph, storage</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubernetes-crd-publish/"><span class="tag">kubernetes, crd, publish</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/network-tcp-ip/"><span class="tag">network, tcp/ip</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.svg" alt="wikix" height="28"></a><p class="is-size-7"><span>&copy; 2021 wikix</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Follow me on GitHub" href="https://github.com/wikix"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>